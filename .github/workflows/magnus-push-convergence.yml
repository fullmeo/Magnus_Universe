name: Magnus Push Convergence

# D√©clench√© √† chaque push sur main ou develop
# Envoie le diff et les fichiers modifi√©s √† Kilo via webhook

on:
  push:
    branches:
      - main
      - develop
      - master
    paths:
      - '**.js'
      - 'examples/**'
      - '.magnus/**'

jobs:
  push-convergence:
    name: Push Code Convergence to Kilo
    runs-on: ubuntu-latest

    steps:
      - name: üåå Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis

      - name: üîÆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üì¶ Install Dependencies
        run: npm ci || npm install

      # Extract session ID from commit message
      - name: üìù Extract Session ID from Commit
        id: session
        run: |
          SESSION_ID="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # Try to extract session-id from commit message
          if [[ $COMMIT_MSG =~ session-([a-zA-Z0-9_-]+) ]]; then
            SESSION_ID="session-${BASH_REMATCH[1]}"
          fi

          echo "SESSION_ID=$SESSION_ID" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Get the diff
      - name: üîç Analyze Code Changes
        id: changes
        run: |
          # Get modified files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} || echo "Initial commit")
          echo "CHANGED_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get detailed diff
          DIFF_CONTENT=$(git diff ${{ github.event.before }}..${{ github.sha }} || git show --stat)
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Run Magnus CLI validation on changed files
      - name: üéØ Run Magnus CLI Validation
        id: validation
        continue-on-error: true
        run: |
          # Validate JavaScript files
          JS_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep '\.js$' || echo "")

          if [ -n "$JS_FILES" ]; then
            # Take the first JS file for validation
            FIRST_FILE=$(echo "$JS_FILES" | head -1)

            if [ -f "$FIRST_FILE" ]; then
              echo "Validating: $FIRST_FILE"
              node magnus-cli.js \
                --mode validate-convergence \
                --session-id "${{ steps.session.outputs.SESSION_ID }}" \
                --code-path "$FIRST_FILE" \
                --feedback "Pushed via GitHub Actions" \
                --output ./.magnus/push-validation-report.json || true
            fi
          else
            echo "No JavaScript files changed"
          fi

      # Read convergence report if it exists
      - name: üìä Read Convergence Report
        id: report
        if: always()
        run: |
          if [ -f "./.magnus/push-validation-report.json" ]; then
            REPORT=$(cat ./.magnus/push-validation-report.json)
            echo "REPORT<<EOF" >> $GITHUB_OUTPUT
            echo "$REPORT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "REPORT={\"status\": \"no-report\"}" >> $GITHUB_OUTPUT
          fi

      # Prepare payload for Kilo webhook
      - name: üîó Prepare Kilo Webhook Payload
        id: payload
        run: |
          cat > /tmp/kilo-payload.json << 'EOF'
          {
            "event_type": "push_convergence",
            "orchestrator": "Serigne",
            "session_id": "${{ steps.session.outputs.SESSION_ID }}",
            "github": {
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "author": "${{ github.actor }}",
              "message": "${{ steps.session.outputs.COMMIT_MSG }}",
              "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            },
            "changes": {
              "modified_files": "${{ steps.changes.outputs.CHANGED_FILES }}",
              "diff_summary": "Available in GitHub"
            },
            "convergence_report": ${{ steps.report.outputs.REPORT }},
            "action_required": "Process convergence analysis and update learning"
          }
          EOF

          cat /tmp/kilo-payload.json

      # Network diagnostics for webhook endpoint
      - name: üåê Network Connectivity Test
        id: network
        continue-on-error: true
        run: |
          echo "Testing network connectivity to webhook infrastructure..."

          # Test basic connectivity to webhook.site
          echo "üì° Testing webhook.site connectivity:"

          # Try HTTP HEAD request
          echo ""
          echo "1Ô∏è‚É£ Testing HTTP HEAD request:"
          curl -I http://webhook.site -v -m 10 2>&1 | head -30

          echo ""
          echo "2Ô∏è‚É£ Testing HTTPS HEAD request:"
          curl -I https://webhook.site -v -m 10 2>&1 | head -30

          # Test DNS from runner
          echo ""
          echo "3Ô∏è‚É£ DNS resolution from GitHub runner:"
          nslookup webhook.site 1.1.1.1 2>&1 | head -10

          # Test connectivity with simple request
          echo ""
          echo "4Ô∏è‚É£ Simple GET request to webhook.site:"
          curl -v https://webhook.site -m 10 2>&1 | head -40

          echo ""
          echo "5Ô∏è‚É£ Checking GitHub runner IP visibility:"
          curl -s https://api.ipify.org
          echo ""

          echo "Network diagnostics complete"

      # Test with alternative webhook service (webhook.cool)
      - name: üîÑ Test with Alternative Webhook Service
        id: alt_webhook
        continue-on-error: true
        run: |
          echo "Testing with webhook.cool (alternative service)..."
          echo ""

          # Test payload
          TEST_PAYLOAD='{
            "event_type": "push_convergence_test",
            "service": "webhook.cool",
            "timestamp": "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'",
            "message": "Testing alternative webhook service from GitHub Actions"
          }'

          echo "üì§ Sending test payload to webhook.cool..."
          echo "Payload:"
          echo "$TEST_PAYLOAD" | jq .

          # Send to webhook.cool (no registration needed, logs publicly)
          RESPONSE=$(curl -X POST "https://webhook.cool/magnus-test" \
            -H "Content-Type: application/json" \
            -d "$TEST_PAYLOAD" \
            -w "\nHTTP_CODE:%{http_code}" \
            -v 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)

          echo ""
          echo "Response:"
          echo "$RESPONSE" | head -50

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
            echo ""
            echo "‚úÖ Alternative webhook service TEST SUCCESSFUL (HTTP $HTTP_CODE)"
            echo "üìã View result at: https://webhook.cool/magnus-test"
          else
            echo ""
            echo "‚ö†Ô∏è Alternative service returned HTTP $HTTP_CODE"
          fi

      # Send to Kilo via webhook
      - name: üöÄ Send to Kilo Webhook
        id: webhook
        continue-on-error: true
        run: |
          WEBHOOK_URL="${{ secrets.KILO_WEBHOOK_1_URL }}"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è  KILO_WEBHOOK_1_URL not configured"
            echo "webhook_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "üì§ Sending webhook to Kilo..."
          echo "Payload size: $(wc -c < /tmp/kilo-payload.json) bytes"

          # Validate URL format
          echo "üîê URL Validation:"
          echo "  Length: ${#WEBHOOK_URL} characters"

          # Check if it's a valid URL format
          if [[ "$WEBHOOK_URL" =~ ^https?:// ]]; then
            echo "  ‚úÖ Protocol detected (http/https)"
          else
            echo "  ‚ùå ERROR: Invalid protocol - URL must start with http:// or https://"
          fi

          if [[ "$WEBHOOK_URL" == *"://"* ]]; then
            echo "  ‚úÖ URL structure appears valid"
          else
            echo "  ‚ùå ERROR: Invalid URL structure"
          fi

          # Extract domain from URL for debugging
          WEBHOOK_DOMAIN=$(echo "$WEBHOOK_URL" | sed -E 's|https?://([^/]+).*|\1|')
          echo "  Target domain: $WEBHOOK_DOMAIN"

          if [ -z "$WEBHOOK_DOMAIN" ]; then
            echo "  ‚ùå ERROR: Could not extract domain from URL"
            echo "webhook_status=invalid_url" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Test DNS resolution
          echo "üîç Testing DNS resolution..."
          nslookup "$WEBHOOK_DOMAIN" 8.8.8.8 2>&1 | head -5 || echo "DNS test unavailable"

          # Test connectivity with verbose curl
          echo "üì° Testing webhook connectivity (verbose)..."

          # Create temporary file for curl output
          CURL_OUTPUT="/tmp/curl_debug.txt"

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @/tmp/kilo-payload.json \
            -w "\nHTTP_CODE:%{http_code}\nTIME_TOTAL:%{time_total}\nCONNECT_TIME:%{time_connect}\n" \
            -v \
            -m 30 \
            > "$CURL_OUTPUT" 2>&1

          CURL_EXIT=$?

          echo "Curl exit code: $CURL_EXIT"
          echo "Curl error codes reference:"
          echo "  0 = Success"
          echo "  3 = URL malformed or invalid"
          echo "  6 = Could not resolve domain"
          echo "  7 = Failed to connect to host"
          echo "  28 = Operation timeout"
          echo "  35 = SSL/TLS connection error"
          echo "  52 = Empty response from server"
          echo ""

          # Extract HTTP code
          HTTP_CODE=$(grep "HTTP_CODE:" "$CURL_OUTPUT" | cut -d: -f2 | head -1)

          if [ -z "$HTTP_CODE" ]; then
            HTTP_CODE="NONE"
          fi

          echo "HTTP response code: $HTTP_CODE"
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

          # Show full curl output for debugging
          echo "üìã Full curl debug output:"
          cat "$CURL_OUTPUT"

          # Determine status
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "webhook_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Webhook sent successfully (HTTP $HTTP_CODE)"
          elif [ "$CURL_EXIT" -ne 0 ]; then
            echo "webhook_status=connection_error" >> $GITHUB_OUTPUT
            echo "‚ùå Connection failed (curl exit: $CURL_EXIT)"
            echo "Possible causes:"
            echo "  - Webhook URL is unreachable"
            echo "  - Network timeout (30s limit)"
            echo "  - DNS resolution failure"
            echo "  - TLS/SSL certificate issue"
          else
            echo "webhook_status=http_error" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Webhook returned HTTP $HTTP_CODE"
          fi

      # Summary
      - name: üìã Workflow Summary
        if: always()
        run: |
          echo "## Magnus Push Convergence Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Session ID**: ${{ steps.session.outputs.SESSION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Orchestrator**: Serigne" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Webhook Status**: ${{ steps.webhook.outputs.webhook_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changes.outputs.CHANGED_FILES }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
